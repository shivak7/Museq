name: Build Museq

on:
  push:
    branches: [ master ]
    paths-ignore:
      - '**.md'
      - 'LICENSE'
      - 'THIRDPARTY_NOTICES.txt'
      - 'muscripts/**'
      - 'sounds/**'
      - '**.png'
      - '**.ico'
      - '.gitignore'
  pull_request:
    branches: [ master ]
    paths-ignore:
      - '**.md'
      - 'LICENSE'
      - 'THIRDPARTY_NOTICES.txt'
      - 'muscripts/**'
      - 'sounds/**'
      - '**.png'
      - '**.ico'
      - '.gitignore'

jobs:
  build-ubuntu:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake libsndfile1-dev libvorbis-dev libogg-dev libmp3lame-dev libflac-dev libopus-dev libmpg123-dev libglfw3-dev libgl1-mesa-dev

    - name: Configure CMake
      run: cmake -B build -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: cmake --build build --config Release

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: museq-studio-ubuntu-x64
        path: |
          build/museq
          build/muqomposer/muqomposer

  build-macos-x64:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install vcpkg
      run: |
        git clone https://github.com/microsoft/vcpkg.git
        ./vcpkg/bootstrap-vcpkg.sh

    - name: Install dependencies
      run: |
        ./vcpkg/vcpkg install libsndfile libvorbis libogg mp3lame libflac opus mpg123 glfw3 --triplet x64-osx

    - name: Configure CMake
      run: cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE=vcpkg/scripts/buildsystems/vcpkg.cmake -DVCPKG_TARGET_TRIPLET=x64-osx -DCMAKE_OSX_ARCHITECTURES=x86_64

    - name: Build
      run: cmake --build build --config Release

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: museq-studio-macos-x64
        path: |
          build/museq
          build/muqomposer/muqomposer

  build-macos-arm64:
    runs-on: macos-latest # Apple Silicon (M1/M2/M3)
    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: brew install cmake libsndfile libvorbis libogg lame flac opus mpg123 glfw

    - name: Configure CMake
      run: cmake -B build -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: cmake --build build --config Release

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: museq-studio-macos-arm64
        path: |
          build/museq
          build/muqomposer/muqomposer

  build-windows:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install vcpkg dependencies
      run: |
        vcpkg install libsndfile libvorbis libogg mp3lame libflac opus mpg123 glfw3 --triplet x64-windows-static
      shell: cmd

    - name: Configure CMake
      run: cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake -DVCPKG_TARGET_TRIPLET=x64-windows-static

    - name: Build
      run: cmake --build build --config Release

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: museq-studio-windows-x64
        path: |
          build/Release/museq.exe
          build/muqomposer/Release/muqomposer.exe
